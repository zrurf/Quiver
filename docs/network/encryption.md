# 加密
加密是保障通信安全的重要手段，因此我们需要设计一个加密方法。

如果直接用HTTPS、WebSocket（WSS），我们可以直接使用TLS安全层加密，而无需考虑其他技术细节。但是在本项目中，我们使用KCP+UDP作为传输层，无法直接使用TLS加密，因此需要设计一个传输层加密。

根据TLS的设计，我们可以得到以下加密流程：

```
握手 -> 密钥协商 -> 数据加密 -> 数据传输
```

而对于密钥协商，有以下流程:
```
C->S: Handshake
S->C: Encryption Request
C->S: Encryption Response
```

因此，如果不考虑SSL劫持的话，我们只需要一个非对称加密算法和一个对称加密算法，即可实现完成简单的通信加密。

但是SSL劫持也是常用的攻击手段，对于游戏而言特别容易被用来作弊，因此仍然需要将通信建立在TLS安全层（TLS v1.2及以上）上。参考Mojang的做法，我们需要使用HTTPS协议与一台签发了可信CA证书的身份验证服务器进行身份验证，这样可以依赖HTTPS的TLS安全层。由于实现复杂度和成本，本项目暂不考虑。

## 算法选择
非对称加密和对称加密选择很多，一般常用的是RSA+AES。但是由于RSA是商业算法，并且有一些丑闻和传言，因此我们可以考虑其他方案。如果是国内项目或保密性要求高的项目，可以考虑使用国密算法家族，包含了对称加密（SM4、ZUC）、非对称加密（SM2）、杂凑（SM3）一系列算法。本文暂不深入讨论。

ECC（圆锥曲线加密）算法是替代RSA的优秀方案，也有很多种实现，例如NIST ECC、SM2（国密家族）、Ed25519等，但是NIST也不是什么好鸟，因此我们使用公共领域的Ed25519。

对于对称算法，AES可以算是标准选择，有常年的沉淀，并且有硬件优化（x86的AES-NI，ARMv8-A的AES扩展指令集），性能和安全性都不错。但是对于有些场特殊景下，比如嵌入式、armeabi-v7a，或者是有MAC认证需求，可以考虑ChaCha20-Poly1305等高速流密码，本文暂不做讨论。我们使用AES算法。

## 加密流程设计
参考Minecraft的通信加密设计，我们设计出了以下加密流程：
```
C->S: Handshake
S   : Generate Key Pair
S->C: Encryption Request    (包含公钥和challenge)
C->S: Encryption Response   (公钥加密后的challenge和对称密钥)
```

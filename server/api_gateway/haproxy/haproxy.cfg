global
    log stdout local0 info
    maxconn 8192
    
defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3
    option http-server-close

frontend http_front
    bind *:80
    mode http

    # X-Forwarded-For
    option forwardfor

    # 黑名单检查
    acl is_blacklist src -f /etc/haproxy/blacklist.acl
    http-request deny if is_blacklist

    # API限流
    acl is_api path_beg /api
    acl is_auth_api path_beg /api/auth

    stick-table type ip size 100k expire 10m store http_req_rate(10s),conn_cur  # API限流表

    # API限流：30请求/10秒
    http-request track-sc0 src if is_api
    http-request deny deny_status 429 if is_api { sc_http_req_rate(0) gt 30 }

    # 连接数限制：防止单个IP连接耗尽
    http-request deny deny_status 429 if { sc_conn_cur(0) gt 50 }

    # 路由规则
    use_backend user_backend if { path_beg /api/auth }
    default_backend user_backend
    
    # 添加监控端点（内部使用）
    acl is_monitor path /monitor
    use_backend monitor_backend if is_monitor

backend user_backend
    mode http
    balance roundrobin

    # 健康检查
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2

    # 后端服务器
    server user1 user_server:80 check maxconn 200

    option http-keep-alive
    http-reuse safe

backend monitor_backend
    mode http
    stats enable
    stats uri /haproxy-monitor
    stats refresh 10s
    stats show-legends
    stats show-node
    stats hide-version
    stats auth admin:nimda_quiver  # 监控密码
    
    # 只允许内部网络访问
    acl network_allowed src 172.21.0.0/24
    http-request deny unless network_allowed

